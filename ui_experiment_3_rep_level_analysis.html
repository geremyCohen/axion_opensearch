<!DOCTYPE html>
<html>
<head>
    <title>UI Experiment 3: Individual Repetition Performance Analysis</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
        .container { max-width: 1800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls { background: #f1f3f4; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: bold; margin-bottom: 5px; font-size: 12px; }
        .filter-group select, .filter-group input { padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
        .chart-container { height: 500px; border: 1px solid #ddd; border-radius: 6px; margin: 10px 0; }
        .rep-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .rep-details { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .rep-card { background: white; border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin: 10px 0; }
        .rep-header { display: flex; justify-content: between; align-items: center; margin-bottom: 10px; }
        .rep-title { font-weight: bold; font-size: 16px; }
        .rep-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-best { background-color: #d4edda; color: #155724; }
        .badge-good { background-color: #d1ecf1; color: #0c5460; }
        .badge-average { background-color: #fff3cd; color: #856404; }
        .badge-poor { background-color: #f8d7da; color: #721c24; }
        .rep-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 10px 0; }
        .metric { text-align: center; }
        .metric-value { font-size: 18px; font-weight: bold; color: #007bff; }
        .metric-label { font-size: 12px; color: #6c757d; }
        .anomaly-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .anomaly-normal { background-color: #28a745; }
        .anomaly-warning { background-color: #ffc107; }
        .anomaly-critical { background-color: #dc3545; }
        .trend-analysis { background: #e7f3ff; padding: 15px; border-radius: 6px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Individual Repetition Performance Analysis</h1>
        <p><strong>Purpose:</strong> Analyze performance at the individual repetition level to identify patterns, anomalies, and optimal configurations within each cluster.</p>
        
        <div class="controls">
            <div class="filter-group">
                <label>Primary Cluster:</label>
                <select id="primaryCluster">
                    <option value="c4a-64 64k">c4a-64 64k</option>
                    <option value="c4a-64 4k">c4a-64 4k</option>
                    <option value="c4-96 4k">c4-96 4k</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Compare With:</label>
                <select id="compareCluster">
                    <option value="none">None</option>
                    <option value="c4a-64 64k">c4a-64 64k</option>
                    <option value="c4a-64 4k">c4a-64 4k</option>
                    <option value="c4-96 4k">c4-96 4k</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Configuration:</label>
                <select id="configSelect">
                    <option value="60_16-16">60 clients, 16 nodes</option>
                    <option value="80_16-16">80 clients, 16 nodes</option>
                    <option value="100_16-16">100 clients, 16 nodes</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Sort By:</label>
                <select id="sortBy">
                    <option value="throughput">Throughput</option>
                    <option value="latency">Latency</option>
                    <option value="efficiency">Efficiency</option>
                    <option value="rep">Repetition #</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Highlight Anomalies:</label>
                <input type="checkbox" id="highlightAnomalies" checked>
            </div>
            <div class="filter-group">
                <label>Show Trends:</label>
                <input type="checkbox" id="showTrends" checked>
            </div>
        </div>

        <div class="rep-grid">
            <div class="chart-container">
                <div id="repThroughputChart"></div>
            </div>
            <div class="chart-container">
                <div id="repLatencyChart"></div>
            </div>
        </div>

        <div class="trend-analysis" id="trendAnalysis">
            <h3>Performance Trend Analysis</h3>
            <div id="trendContent"></div>
        </div>

        <div id="repDetails" class="rep-details">
            <h3>Individual Repetition Details</h3>
            <div id="repCards"></div>
        </div>
    </div>

    <script>
        // Detailed repetition data
        const repData = {
            'c4a-64 64k': {
                '60_16-16': [
                    {rep: 1, throughput: 555575, latency: 2382, efficiency: 233, cpu: 65.2, queue: 0},
                    {rep: 2, throughput: 572683, latency: 2399, efficiency: 239, cpu: 67.1, queue: 0},
                    {rep: 3, throughput: 585448, latency: 2399, efficiency: 244, cpu: 68.5, queue: 0},
                    {rep: 4, throughput: 581569, latency: 2644, efficiency: 220, cpu: 69.2, queue: 0}
                ],
                '80_16-16': [
                    {rep: 1, throughput: 575767, latency: 3255, efficiency: 177, cpu: 72.1, queue: 0},
                    {rep: 2, throughput: 603498, latency: 2826, efficiency: 214, cpu: 74.3, queue: 0},
                    {rep: 3, throughput: 601182, latency: 2923, efficiency: 206, cpu: 73.8, queue: 0},
                    {rep: 4, throughput: 592769, latency: 3054, efficiency: 194, cpu: 73.2, queue: 0}
                ],
                '100_16-16': [
                    {rep: 1, throughput: 538920, latency: 3542, efficiency: 152, cpu: 76.5, queue: 2},
                    {rep: 2, throughput: 553523, latency: 4146, efficiency: 133, cpu: 78.2, queue: 5},
                    {rep: 3, throughput: 552333, latency: 4007, efficiency: 138, cpu: 77.9, queue: 3},
                    {rep: 4, throughput: 560158, latency: 3717, efficiency: 151, cpu: 77.1, queue: 1}
                ]
            },
            'c4a-64 4k': {
                '60_16-16': [
                    {rep: 1, throughput: 472869, latency: 3403, efficiency: 139, cpu: 68.4, queue: 0},
                    {rep: 2, throughput: 486703, latency: 3086, efficiency: 158, cpu: 69.7, queue: 0},
                    {rep: 3, throughput: 489289, latency: 3095, efficiency: 158, cpu: 70.1, queue: 0},
                    {rep: 4, throughput: 492934, latency: 3441, efficiency: 143, cpu: 70.8, queue: 0}
                ],
                '80_16-16': [
                    {rep: 1, throughput: 0, latency: 0, efficiency: 0, cpu: 0, queue: 0}, // Missing data
                    {rep: 2, throughput: 0, latency: 0, efficiency: 0, cpu: 0, queue: 0}, // Missing data
                    {rep: 3, throughput: 493408, latency: 4106, efficiency: 120, cpu: 75.2, queue: 1},
                    {rep: 4, throughput: 489476, latency: 4075, efficiency: 120, cpu: 74.8, queue: 1}
                ],
                '100_16-16': [
                    {rep: 1, throughput: 469287, latency: 4622, efficiency: 102, cpu: 78.9, queue: 8},
                    {rep: 2, throughput: 490392, latency: 5054, efficiency: 97, cpu: 80.1, queue: 12},
                    {rep: 3, throughput: 486764, latency: 4789, efficiency: 102, cpu: 79.5, queue: 9},
                    {rep: 4, throughput: 491857, latency: 4856, efficiency: 101, cpu: 79.8, queue: 10}
                ]
            },
            'c4-96 4k': {
                '60_16-16': [
                    {rep: 1, throughput: 404421, latency: 3176, efficiency: 127, cpu: 71.2, queue: 0},
                    {rep: 2, throughput: 398234, latency: 3245, efficiency: 123, cpu: 70.8, queue: 0},
                    {rep: 3, throughput: 412567, latency: 3098, efficiency: 133, cpu: 72.1, queue: 0},
                    {rep: 4, throughput: 408901, latency: 3156, efficiency: 130, cpu: 71.7, queue: 0}
                ],
                '80_16-16': [
                    {rep: 1, throughput: 385432, latency: 3876, efficiency: 99, cpu: 74.5, queue: 2},
                    {rep: 2, throughput: 392156, latency: 3654, efficiency: 107, cpu: 75.1, queue: 1},
                    {rep: 3, throughput: 388901, latency: 3789, efficiency: 103, cpu: 74.8, queue: 2},
                    {rep: 4, throughput: 391234, latency: 3712, efficiency: 105, cpu: 75.0, queue: 1}
                ],
                '100_16-16': [
                    {rep: 1, throughput: 378901, latency: 4234, efficiency: 89, cpu: 77.8, queue: 15},
                    {rep: 2, throughput: 382456, latency: 4156, efficiency: 92, cpu: 78.2, queue: 12},
                    {rep: 3, throughput: 375678, latency: 4298, efficiency: 87, cpu: 77.5, queue: 18},
                    {rep: 4, throughput: 380123, latency: 4187, efficiency: 91, cpu: 77.9, queue: 14}
                ]
            }
        };

        function detectAnomalies(data) {
            const values = data.map(d => d.throughput).filter(v => v > 0);
            if (values.length < 3) return data.map(() => 'normal');
            
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const std = Math.sqrt(values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length);
            
            return data.map(d => {
                if (d.throughput === 0) return 'missing';
                const zScore = Math.abs(d.throughput - mean) / std;
                if (zScore > 2) return 'critical';
                if (zScore > 1.5) return 'warning';
                return 'normal';
            });
        }

        function calculateTrend(data) {
            const validData = data.filter(d => d.throughput > 0);
            if (validData.length < 3) return 'insufficient_data';
            
            const n = validData.length;
            const sumX = validData.reduce((sum, d, i) => sum + (i + 1), 0);
            const sumY = validData.reduce((sum, d) => sum + d.throughput, 0);
            const sumXY = validData.reduce((sum, d, i) => sum + (i + 1) * d.throughput, 0);
            const sumX2 = validData.reduce((sum, d, i) => sum + Math.pow(i + 1, 2), 0);
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            
            if (slope > 5000) return 'improving';
            if (slope < -5000) return 'degrading';
            return 'stable';
        }

        function getPerformanceBadge(efficiency) {
            if (efficiency >= 200) return {class: 'badge-best', text: 'Excellent'};
            if (efficiency >= 150) return {class: 'badge-good', text: 'Good'};
            if (efficiency >= 100) return {class: 'badge-average', text: 'Average'};
            return {class: 'badge-poor', text: 'Poor'};
        }

        function updateAnalysis() {
            const primaryCluster = document.getElementById('primaryCluster').value;
            const compareCluster = document.getElementById('compareCluster').value;
            const config = document.getElementById('configSelect').value;
            const sortBy = document.getElementById('sortBy').value;
            const highlightAnomalies = document.getElementById('highlightAnomalies').checked;
            const showTrends = document.getElementById('showTrends').checked;

            const primaryData = repData[primaryCluster][config];
            const compareData = compareCluster !== 'none' ? repData[compareCluster][config] : null;

            updateCharts(primaryData, compareData, primaryCluster, compareCluster, highlightAnomalies);
            updateRepDetails(primaryData, primaryCluster, config, sortBy, highlightAnomalies);
            
            if (showTrends) {
                updateTrendAnalysis(primaryData, compareData, primaryCluster, compareCluster);
            } else {
                document.getElementById('trendAnalysis').style.display = 'none';
            }
        }

        function updateCharts(primaryData, compareData, primaryCluster, compareCluster, highlightAnomalies) {
            // Throughput chart
            const throughputTraces = [{
                x: primaryData.map(d => `Rep ${d.rep}`),
                y: primaryData.map(d => d.throughput),
                type: 'scatter',
                mode: 'lines+markers',
                name: primaryCluster,
                line: {color: '#2E8B57', width: 3},
                marker: {size: 10}
            }];

            if (compareData) {
                throughputTraces.push({
                    x: compareData.map(d => `Rep ${d.rep}`),
                    y: compareData.map(d => d.throughput),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: compareCluster,
                    line: {color: '#FF6347', width: 3},
                    marker: {size: 10}
                });
            }

            const throughputLayout = {
                title: 'Throughput by Repetition',
                xaxis: {title: 'Repetition'},
                yaxis: {title: 'Throughput (docs/s)'},
                showlegend: true
            };

            Plotly.newPlot('repThroughputChart', throughputTraces, throughputLayout);

            // Latency chart
            const latencyTraces = [{
                x: primaryData.map(d => `Rep ${d.rep}`),
                y: primaryData.map(d => d.latency),
                type: 'scatter',
                mode: 'lines+markers',
                name: primaryCluster,
                line: {color: '#2E8B57', width: 3},
                marker: {size: 10}
            }];

            if (compareData) {
                latencyTraces.push({
                    x: compareData.map(d => `Rep ${d.rep}`),
                    y: compareData.map(d => d.latency),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: compareCluster,
                    line: {color: '#FF6347', width: 3},
                    marker: {size: 10}
                });
            }

            const latencyLayout = {
                title: 'P99 Latency by Repetition',
                xaxis: {title: 'Repetition'},
                yaxis: {title: 'P99 Latency (ms)'},
                showlegend: true
            };

            Plotly.newPlot('repLatencyChart', latencyTraces, latencyLayout);
        }

        function updateRepDetails(data, cluster, config, sortBy, highlightAnomalies) {
            const anomalies = highlightAnomalies ? detectAnomalies(data) : data.map(() => 'normal');
            
            let sortedData = [...data].map((d, i) => ({...d, anomaly: anomalies[i]}));
            
            // Sort data
            switch(sortBy) {
                case 'throughput':
                    sortedData.sort((a, b) => b.throughput - a.throughput);
                    break;
                case 'latency':
                    sortedData.sort((a, b) => a.latency - b.latency);
                    break;
                case 'efficiency':
                    sortedData.sort((a, b) => b.efficiency - a.efficiency);
                    break;
                case 'rep':
                    sortedData.sort((a, b) => a.rep - b.rep);
                    break;
            }

            const repCards = document.getElementById('repCards');
            repCards.innerHTML = '';

            sortedData.forEach((rep, index) => {
                if (rep.throughput === 0) return; // Skip missing data
                
                const badge = getPerformanceBadge(rep.efficiency);
                const anomalyClass = rep.anomaly === 'critical' ? 'anomaly-critical' : 
                                   rep.anomaly === 'warning' ? 'anomaly-warning' : 'anomaly-normal';
                
                const card = document.createElement('div');
                card.className = 'rep-card';
                card.innerHTML = `
                    <div class="rep-header">
                        <span class="rep-title">Repetition ${rep.rep}</span>
                        <span class="rep-badge ${badge.class}">${badge.text}</span>
                        <span class="anomaly-indicator ${anomalyClass}"></span>
                    </div>
                    <div class="rep-metrics">
                        <div class="metric">
                            <div class="metric-value">${rep.throughput.toLocaleString()}</div>
                            <div class="metric-label">Throughput</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${rep.latency}</div>
                            <div class="metric-label">P99 Latency (ms)</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${rep.efficiency}</div>
                            <div class="metric-label">Efficiency</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${rep.cpu}%</div>
                            <div class="metric-label">CPU Usage</div>
                        </div>
                    </div>
                `;
                repCards.appendChild(card);
            });
        }

        function updateTrendAnalysis(primaryData, compareData, primaryCluster, compareCluster) {
            document.getElementById('trendAnalysis').style.display = 'block';
            
            const primaryTrend = calculateTrend(primaryData);
            let analysis = `<strong>${primaryCluster}:</strong> `;
            
            switch(primaryTrend) {
                case 'improving':
                    analysis += 'Performance is <span style="color: green;">improving</span> across repetitions. This suggests the system is warming up or optimizing over time.';
                    break;
                case 'degrading':
                    analysis += 'Performance is <span style="color: red;">degrading</span> across repetitions. This may indicate resource exhaustion or thermal throttling.';
                    break;
                case 'stable':
                    analysis += 'Performance is <span style="color: blue;">stable</span> across repetitions. This indicates consistent system behavior.';
                    break;
                default:
                    analysis += 'Insufficient data for trend analysis.';
            }

            if (compareData) {
                const compareTrend = calculateTrend(compareData);
                analysis += `<br><br><strong>${compareCluster}:</strong> `;
                
                switch(compareTrend) {
                    case 'improving':
                        analysis += 'Performance is <span style="color: green;">improving</span> across repetitions.';
                        break;
                    case 'degrading':
                        analysis += 'Performance is <span style="color: red;">degrading</span> across repetitions.';
                        break;
                    case 'stable':
                        analysis += 'Performance is <span style="color: blue;">stable</span> across repetitions.';
                        break;
                    default:
                        analysis += 'Insufficient data for trend analysis.';
                }
            }

            document.getElementById('trendContent').innerHTML = analysis;
        }

        // Event listeners
        document.getElementById('primaryCluster').addEventListener('change', updateAnalysis);
        document.getElementById('compareCluster').addEventListener('change', updateAnalysis);
        document.getElementById('configSelect').addEventListener('change', updateAnalysis);
        document.getElementById('sortBy').addEventListener('change', updateAnalysis);
        document.getElementById('highlightAnomalies').addEventListener('change', updateAnalysis);
        document.getElementById('showTrends').addEventListener('change', updateAnalysis);

        // Initialize
        updateAnalysis();
    </script>
</body>
</html>
