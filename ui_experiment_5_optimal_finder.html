<!DOCTYPE html>
<html>
<head>
    <title>UI Experiment 5: Optimal Configuration Finder</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
        .container { max-width: 1800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .wizard { background: #f1f3f4; padding: 20px; border-radius: 6px; margin-bottom: 20px; }
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        .step-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #007bff; }
        .requirement-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 15px 0; }
        .requirement-card { background: white; padding: 15px; border-radius: 6px; border: 2px solid #ddd; cursor: pointer; transition: all 0.3s; }
        .requirement-card.selected { border-color: #007bff; background-color: #e7f3ff; }
        .requirement-card h4 { margin: 0 0 10px 0; color: #007bff; }
        .slider-group { margin: 15px 0; }
        .slider-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .slider-container { display: flex; align-items: center; gap: 10px; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .chart-container { height: 400px; border: 1px solid #ddd; border-radius: 6px; }
        .recommendation-card { background: #e7f3ff; border-left: 4px solid #007bff; padding: 15px; margin: 10px 0; border-radius: 6px; }
        .config-comparison { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .config-card { background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #ddd; }
        .config-card.winner { background: #d4edda; border-color: #28a745; }
        .metric-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .metric-label { font-size: 12px; color: #6c757d; }
        .wizard-nav { display: flex; justify-content: space-between; margin-top: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Optimal Configuration Finder</h1>
        <p><strong>Purpose:</strong> Interactive wizard to find the best cluster configuration based on your specific performance requirements and constraints.</p>
        
        <div class="wizard">
            <!-- Step 1: Performance Priority -->
            <div class="wizard-step active" id="step1">
                <div class="step-header">Step 1: What's your primary performance goal?</div>
                <div class="requirement-grid">
                    <div class="requirement-card" data-priority="throughput">
                        <h4>Maximum Throughput</h4>
                        <p>Highest possible documents/second</p>
                        <small>Best for bulk indexing workloads</small>
                    </div>
                    <div class="requirement-card" data-priority="latency">
                        <h4>Minimum Latency</h4>
                        <p>Lowest possible response times</p>
                        <small>Best for real-time applications</small>
                    </div>
                    <div class="requirement-card" data-priority="balanced">
                        <h4>Balanced Performance</h4>
                        <p>Good throughput with acceptable latency</p>
                        <small>Best for mixed workloads</small>
                    </div>
                </div>
            </div>

            <!-- Step 2: Performance Constraints -->
            <div class="wizard-step" id="step2">
                <div class="step-header">Step 2: Set your performance constraints</div>
                <div class="slider-group">
                    <label>Minimum Throughput Required (docs/s):</label>
                    <div class="slider-container">
                        <input type="range" id="minThroughput" min="300000" max="600000" value="400000" step="10000">
                        <span id="minThroughputValue">400,000</span>
                    </div>
                </div>
                <div class="slider-group">
                    <label>Maximum Acceptable Latency (ms):</label>
                    <div class="slider-container">
                        <input type="range" id="maxLatency" min="2000" max="6000" value="4000" step="100">
                        <span id="maxLatencyValue">4,000</span>
                    </div>
                </div>
                <div class="slider-group">
                    <label>Consistency Importance (lower CV% preferred):</label>
                    <div class="slider-container">
                        <input type="range" id="consistencyWeight" min="0" max="100" value="50" step="10">
                        <span id="consistencyValue">50%</span>
                    </div>
                </div>
            </div>

            <!-- Step 3: Resource Constraints -->
            <div class="wizard-step" id="step3">
                <div class="step-header">Step 3: What are your resource constraints?</div>
                <div class="requirement-grid">
                    <div class="requirement-card" data-resource="cost">
                        <h4>Cost Optimized</h4>
                        <p>Minimize infrastructure costs</p>
                        <small>Prefer smaller instance types</small>
                    </div>
                    <div class="requirement-card" data-resource="performance">
                        <h4>Performance Optimized</h4>
                        <p>Best performance regardless of cost</p>
                        <small>Use best available resources</small>
                    </div>
                    <div class="requirement-card" data-resource="balanced">
                        <h4>Balanced Approach</h4>
                        <p>Good performance at reasonable cost</p>
                        <small>Optimize price/performance ratio</small>
                    </div>
                </div>
            </div>

            <!-- Step 4: Results -->
            <div class="wizard-step" id="step4">
                <div class="step-header">Step 4: Recommended Configurations</div>
                <div id="recommendations"></div>
                <div class="results-grid">
                    <div class="chart-container">
                        <div id="optimalChart"></div>
                    </div>
                    <div class="chart-container">
                        <div id="comparisonChart"></div>
                    </div>
                </div>
                <div class="config-comparison" id="configComparison"></div>
            </div>

            <div class="wizard-nav">
                <button class="btn btn-secondary" id="prevBtn" onclick="changeStep(-1)" disabled>Previous</button>
                <button class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">Next</button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let userPreferences = {
            priority: null,
            minThroughput: 400000,
            maxLatency: 4000,
            consistencyWeight: 50,
            resource: null
        };

        // Performance data with additional metadata
        const configData = [
            {cluster: 'c4a-64 64k', config: '60_16-16', throughput: 573819, latency: 2456, efficiency: 234, cv: 2.3, cost: 'medium', reps: [555575, 572683, 585448, 581569]},
            {cluster: 'c4a-64 64k', config: '80_16-16', throughput: 593304, latency: 3014, efficiency: 197, cv: 2.1, cost: 'medium', reps: [575767, 603498, 601182, 592769]},
            {cluster: 'c4a-64 64k', config: '100_16-16', throughput: 551234, latency: 3853, efficiency: 143, cv: 1.6, cost: 'medium', reps: [538920, 553523, 552333, 560158]},
            {cluster: 'c4a-64 4k', config: '60_16-16', throughput: 485449, latency: 3256, efficiency: 149, cv: 1.8, cost: 'medium', reps: [472869, 486703, 489289, 492934]},
            {cluster: 'c4a-64 4k', config: '80_16-16', throughput: 491442, latency: 4091, efficiency: 120, cv: 0.6, cost: 'medium', reps: [493408, 489476]},
            {cluster: 'c4a-64 4k', config: '100_16-16', throughput: 484575, latency: 4830, efficiency: 100, cv: 2.1, cost: 'medium', reps: [469287, 490392, 486764, 491857]},
            {cluster: 'c4-96 4k', config: '60_16-16', throughput: 406031, latency: 3169, efficiency: 128, cv: 1.7, cost: 'high', reps: [404421, 398234, 412567, 408901]},
            {cluster: 'c4-96 4k', config: '80_16-16', throughput: 389431, latency: 3758, efficiency: 104, cv: 0.9, cost: 'high', reps: [385432, 392156, 388901, 391234]},
            {cluster: 'c4-96 4k', config: '100_16-16', throughput: 379290, latency: 4219, efficiency: 90, cv: 0.9, cost: 'high', reps: [378901, 382456, 375678, 380123]}
        ];

        function changeStep(direction) {
            const steps = document.querySelectorAll('.wizard-step');
            steps[currentStep - 1].classList.remove('active');
            
            currentStep += direction;
            
            if (currentStep < 1) currentStep = 1;
            if (currentStep > 4) currentStep = 4;
            
            steps[currentStep - 1].classList.add('active');
            
            document.getElementById('prevBtn').disabled = currentStep === 1;
            document.getElementById('nextBtn').textContent = currentStep === 4 ? 'Start Over' : 'Next';
            
            if (currentStep === 4) {
                generateRecommendations();
            } else if (currentStep === 1 && direction === 1) {
                // Reset when starting over
                userPreferences = {priority: null, minThroughput: 400000, maxLatency: 4000, consistencyWeight: 50, resource: null};
                document.querySelectorAll('.requirement-card').forEach(card => card.classList.remove('selected'));
            }
        }

        function calculateScore(config) {
            let score = 0;
            
            // Base efficiency score
            score += config.efficiency;
            
            // Priority adjustments
            if (userPreferences.priority === 'throughput') {
                score += (config.throughput / 10000); // Bonus for high throughput
            } else if (userPreferences.priority === 'latency') {
                score += (6000 - config.latency) / 10; // Bonus for low latency
            } else if (userPreferences.priority === 'balanced') {
                score += config.efficiency * 0.5; // Balanced approach
            }
            
            // Consistency bonus
            const consistencyBonus = (100 - userPreferences.consistencyWeight) / 100;
            score += (10 - config.cv) * consistencyBonus * 5;
            
            // Resource constraint adjustments
            if (userPreferences.resource === 'cost') {
                if (config.cost === 'high') score -= 50;
                if (config.cluster.includes('c4-96')) score -= 30; // Penalize larger instances
            } else if (userPreferences.resource === 'performance') {
                if (config.cost === 'high') score += 20; // Bonus for premium resources
            }
            
            // Hard constraints
            if (config.throughput < userPreferences.minThroughput) score -= 100;
            if (config.latency > userPreferences.maxLatency) score -= 100;
            
            return Math.max(0, score);
        }

        function generateRecommendations() {
            // Calculate scores for all configurations
            const scoredConfigs = configData.map(config => ({
                ...config,
                score: calculateScore(config)
            })).sort((a, b) => b.score - a.score);

            // Get top 3 recommendations
            const topConfigs = scoredConfigs.slice(0, 3);
            
            displayRecommendations(topConfigs);
            updateCharts(topConfigs, scoredConfigs);
        }

        function displayRecommendations(topConfigs) {
            const container = document.getElementById('recommendations');
            container.innerHTML = '';

            topConfigs.forEach((config, index) => {
                const card = document.createElement('div');
                card.className = 'recommendation-card';
                card.innerHTML = `
                    <h4>Recommendation ${index + 1}: ${config.cluster} (${config.config})</h4>
                    <p><strong>Why this configuration:</strong></p>
                    <ul>
                        <li>Throughput: ${config.throughput.toLocaleString()} docs/s (${config.throughput >= userPreferences.minThroughput ? '✓' : '✗'} meets requirement)</li>
                        <li>P99 Latency: ${config.latency}ms (${config.latency <= userPreferences.maxLatency ? '✓' : '✗'} meets requirement)</li>
                        <li>Efficiency Score: ${config.efficiency} (${config.efficiency >= 150 ? 'Excellent' : config.efficiency >= 100 ? 'Good' : 'Average'})</li>
                        <li>Consistency: ${config.cv}% CV (${config.cv <= 3 ? 'Very Consistent' : config.cv <= 5 ? 'Consistent' : 'Variable'})</li>
                        <li>Overall Score: ${Math.round(config.score)}</li>
                    </ul>
                `;
                container.appendChild(card);
            });

            // Update comparison cards
            updateComparisonCards(topConfigs);
        }

        function updateComparisonCards(topConfigs) {
            const container = document.getElementById('configComparison');
            container.innerHTML = '';

            topConfigs.forEach((config, index) => {
                const card = document.createElement('div');
                card.className = `config-card ${index === 0 ? 'winner' : ''}`;
                card.innerHTML = `
                    <h4>${config.cluster}</h4>
                    <p>${config.config}</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                        <div style="text-align: center;">
                            <div class="metric-value">${config.throughput.toLocaleString()}</div>
                            <div class="metric-label">Throughput</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="metric-value">${config.latency}</div>
                            <div class="metric-label">P99 Latency</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="metric-value">${config.efficiency}</div>
                            <div class="metric-label">Efficiency</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="metric-value">${config.cv}%</div>
                            <div class="metric-label">CV</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <strong>Score: ${Math.round(config.score)}</strong>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateCharts(topConfigs, allConfigs) {
            // Optimal configuration chart
            const optimalTrace = {
                x: topConfigs.map(c => c.latency),
                y: topConfigs.map(c => c.throughput),
                mode: 'markers',
                type: 'scatter',
                name: 'Recommended',
                marker: {
                    color: ['#28a745', '#17a2b8', '#ffc107'],
                    size: [20, 15, 12],
                    line: {color: '#000', width: 2}
                },
                text: topConfigs.map(c => `${c.cluster}<br>${c.config}<br>Score: ${Math.round(c.score)}`),
                hovertemplate: '%{text}<br>Latency: %{x}ms<br>Throughput: %{y:,} docs/s<extra></extra>'
            };

            // Add all other configs as background
            const otherConfigs = allConfigs.slice(3);
            const backgroundTrace = {
                x: otherConfigs.map(c => c.latency),
                y: otherConfigs.map(c => c.throughput),
                mode: 'markers',
                type: 'scatter',
                name: 'Other Configs',
                marker: {
                    color: '#cccccc',
                    size: 8,
                    opacity: 0.5
                },
                text: otherConfigs.map(c => `${c.cluster}<br>${c.config}<br>Score: ${Math.round(c.score)}`),
                hovertemplate: '%{text}<br>Latency: %{x}ms<br>Throughput: %{y:,} docs/s<extra></extra>'
            };

            const optimalLayout = {
                title: 'Recommended Configurations',
                xaxis: {title: 'P99 Latency (ms)'},
                yaxis: {title: 'Throughput (docs/s)'},
                showlegend: true
            };

            Plotly.newPlot('optimalChart', [backgroundTrace, optimalTrace], optimalLayout);

            // Score comparison chart
            const scoreTrace = {
                x: topConfigs.map(c => `${c.cluster} ${c.config}`),
                y: topConfigs.map(c => c.score),
                type: 'bar',
                marker: {color: ['#28a745', '#17a2b8', '#ffc107']}
            };

            const scoreLayout = {
                title: 'Configuration Scores',
                xaxis: {title: 'Configuration'},
                yaxis: {title: 'Score'},
                showlegend: false
            };

            Plotly.newPlot('comparisonChart', [scoreTrace], scoreLayout);
        }

        // Event listeners for requirement cards
        document.querySelectorAll('.requirement-card').forEach(card => {
            card.addEventListener('click', function() {
                const step = this.closest('.wizard-step');
                step.querySelectorAll('.requirement-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                
                if (step.id === 'step1') {
                    userPreferences.priority = this.dataset.priority;
                } else if (step.id === 'step3') {
                    userPreferences.resource = this.dataset.resource;
                }
            });
        });

        // Event listeners for sliders
        document.getElementById('minThroughput').addEventListener('input', function() {
            userPreferences.minThroughput = parseInt(this.value);
            document.getElementById('minThroughputValue').textContent = parseInt(this.value).toLocaleString();
        });

        document.getElementById('maxLatency').addEventListener('input', function() {
            userPreferences.maxLatency = parseInt(this.value);
            document.getElementById('maxLatencyValue').textContent = parseInt(this.value).toLocaleString();
        });

        document.getElementById('consistencyWeight').addEventListener('input', function() {
            userPreferences.consistencyWeight = parseInt(this.value);
            document.getElementById('consistencyValue').textContent = this.value + '%';
        });

        // Override next button for step 4
        document.getElementById('nextBtn').addEventListener('click', function() {
            if (currentStep === 4) {
                // Start over
                currentStep = 0;
                changeStep(1);
            }
        });
    </script>
</body>
</html>
